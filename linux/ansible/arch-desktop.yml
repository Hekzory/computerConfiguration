- name: Include arch-core.yml
  import_playbook: arch-core.yml

- name: Arch-desktop.yml - desktop setup for arch
  hosts: arch
  become: false
  vars:
    the_user: "{{ ansible_facts['user_id'] }}"
    user_home: "{{ ansible_facts['env'].HOME }}"
    is_wsl: "{{ 'microsoft' in (ansible_facts['kernel'] | lower) }}"

  handlers:
    - name: Rebuild font cache
      listen: fonts_changed
      ansible.builtin.command: fc-cache -f
      changed_when: true

  tasks:
    - name: Verify not running under WSL
      ansible.builtin.assert:
        that: not (is_wsl | bool)
        fail_msg: "This desktop playbook should not run under WSL"
        success_msg: "Bare-metal or VM confirmed"

    # Cleanup first
    - name: Remove unneeded packages if present
      become: true
      community.general.pacman:
        name:
          - prismlauncher-git-debug # Debugging artifacts, begone
          - ttf-meslo-nerd-font-powerlevel10k # Legacy font
          - jdk23-graalvm-ee-bin # nope
          - jdk22-graalvm-ee-bin # Yesterday's Java
          - jdk21-graalvm-ee-bin # Ancient Java (meanwhile, java 8 users...)
          - ttf-fira-code # already used, but without nerd patches
        state: absent

    # PACKAGES - Official repos desktop packages setup
    - name: Setup desktop packages
      become: true
      notify: fonts_changed
      community.general.pacman:
        update_cache: true
        name:
          # Typography Foundation
          - ttf-roboto # The backbone of modern interfaces
          - ttf-hack # Monospace perfection
          - ttf-liberation # Freedom in letterforms
          - noto-fonts # Unicode coverage done right
          - noto-fonts-extra # Because *every* glyph matters
          - noto-fonts-emoji # Expression through pictographs
          - adobe-source-sans-fonts # Professional grade typography
          - ttf-firacode-nerd
          - ttf-jetbrains-mono-nerd
          # Core Experience
          - mpv # Video playback ascended
          - realtime-privileges
          - kitty # Terminal emulation evolved
          - ttf-meslo-nerd # Glyphs for the discerning eye
        state: present

    # PACKAGES - AUR desktop packages setup
    - name: Install packages from AUR using yay
      kewlfft.aur.aur:
        name:
          - google-chrome-beta # Web browsing on the somewhat-bleeding edge
          - jdk24-graalvm-ee-bin # newer one
        use: yay
        state: present

    # CONFIG - Optimization and/or compatibility improvements
    - name: Add user to realtime group for low-latency audio
      become: true
      ansible.builtin.user:
        name: "{{ the_user }}"
        groups:
          - realtime
        append: true
    # CONFIG - dotfiles
    - name: Copy desktop dotfiles
      ansible.builtin.copy:
        src: "user_home/{{ item }}"
        dest: "{{ user_home }}/{{ item }}"
        force: true
        owner: "{{ the_user }}"
        group: "{{ the_user }}"
        mode: u+rw,g+r,o--
      loop:
        - .config/kitty/
        - .config/chrome-beta-flags.conf
