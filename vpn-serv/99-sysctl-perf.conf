# ──────────────────────────────────────────────
# IP FORWARDING (essential for VPN routing)
# ──────────────────────────────────────────────
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# ──────────────────────────────────────────────
# NETWORK BUFFER SIZES
# Increase receive/send buffer limits
# ──────────────────────────────────────────────
# Default and max socket buffer sizes (bytes)
net.core.rmem_default = 1048576
net.core.wmem_default = 1048576
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864

# TCP buffer auto-tuning: min / default / max (bytes)
net.ipv4.tcp_rmem = 4096 1048576 67108864
net.ipv4.tcp_wmem = 4096 1048576 67108864

# UDP buffer limits (critical for WireGuard)
# to set
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192


net.core.optmem_max = 131072

# ──────────────────────────────────────────────
# NETWORK QUEUE / BACKLOG
# ──────────────────────────────────────────────
# Max packets queued on INPUT before kernel processes them
net.core.netdev_max_backlog = 250000

# Max number of connections queued for acceptance
net.core.somaxconn = 8192
net.ipv4.tcp_max_syn_backlog=8192

# Budget — max packets processed per softirq cycle
net.core.netdev_budget = 600

# Optional: default queueing discipline (fq works well with BBR)
net.core.default_qdisc = fq

# ──────────────────────────────────────────────
# TCP PERFORMANCE
# ──────────────────────────────────────────────
# BBR congestion control (best for VPN/proxy traffic)
net.ipv4.tcp_congestion_control = bbr

# Enable TCP Fast Open (client + server)
net.ipv4.tcp_fastopen = 3

# Reuse TIME_WAIT sockets for new connections when safe
net.ipv4.tcp_tw_reuse = 1

# TCP keepalive (detect dead connections faster)
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5

# Faster retransmit / recovery
net.ipv4.tcp_early_retrans = 3
net.ipv4.tcp_slow_start_after_idle = 0

# Window scaling & timestamps
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1

# Max SYN backlog
net.ipv4.tcp_max_syn_backlog = 8192

# FIN timeout — how long to hold socket in FIN-WAIT-2
net.ipv4.tcp_fin_timeout = 15

# Max TIME_WAIT sockets
net.ipv4.tcp_max_tw_buckets = 65536

net.ipv4.tcp_mtu_probing = 1

# ──────────────────────────────────────────────
# CONNECTION TRACKING (nf_conntrack)
# Critical for NAT/VPN — undersized = dropped packets
# ──────────────────────────────────────────────
net.netfilter.nf_conntrack_max = 262144
net.netfilter.nf_conntrack_buckets = 65536

# Timeout tuning (seconds) — shorter = free memory faster
net.netfilter.nf_conntrack_tcp_timeout_established = 7200
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 30
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 30
net.netfilter.nf_conntrack_udp_timeout = 30
net.netfilter.nf_conntrack_udp_timeout_stream = 120
net.netfilter.nf_conntrack_generic_timeout = 60

# ──────────────────────────────────────────────
# LOCAL PORT RANGE & NEIGHBOR TABLE
# ──────────────────────────────────────────────
# More ephemeral ports for outbound connections (Xray proxying)
net.ipv4.ip_local_port_range = 1024 65535

# ──────────────────────────────────────────────
# MEMORY / VM
# ──────────────────────────────────────────────
# Don't swap unless absolutely necessary
vm.swappiness = 10

# Prefer keeping inode/dentry caches
vm.vfs_cache_pressure = 50

# Increase max memory map areas (helps high-connection workloads)
vm.max_map_count = 1048576

# ──────────────────────────────────────────────
# FILE DESCRIPTORS
# ──────────────────────────────────────────────
fs.file-max = 2097152
fs.nr_open = 2097152

# ECN — Explicit Congestion Notification
# Works with BBR to reduce packet loss; most modern servers support it
net.ipv4.tcp_ecn = 2

# Increase max queued events for epoll (Xray and WireGuard use epoll)
fs.epoll.max_user_watches = 1048576

# Loose mode (2) instead of strict (1). Strict mode drops packets arriving on "wrong" interfaces — very common with VPN routing
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2

# A VPN gateway should never send or accept ICMP redirects.
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# syn attacks
net.ipv4.tcp_syncookies = 1

net.ipv4.tcp_no_metrics_save = 1

net.core.bpf_jit_enable = 1
